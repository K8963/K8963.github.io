---
title: 大文件切片上传
date: 2023-05-18 23:10:00
comments: false
author: 8963
tags:
  - Laravel
  - vue
categories:
  - 开发
---

大文件切片上传

<!-- more -->

# 前端

## html

```html
<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0"
    />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Document</title>
    <style>
      #progress {
        width: 300px;
        height: 20px;
        background-color: #f7f7f7;
        box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.1);
        border-radius: 4px;
        background-image: linear-gradient(to bottom, #f5f5f5, #f9f9f9);
      }

      #finish {
        background-color: #149bdf;
        background-image: linear-gradient(
          45deg,
          rgba(255, 255, 255, 0.15) 25%,
          transparent 25%,
          transparent 50%,
          rgba(255, 255, 255, 0.15) 50%,
          rgba(255, 255, 255, 0.15) 75%,
          transparent 75%,
          transparent
        );
        background-size: 40px 40px;
        display: inline-block;
        height: 20px;
      }
      form {
        margin-top: 50px;
      }
    </style>
  </head>
  <body>
    <p id="progress">
      <span id="finish" style="width: 0%" progress="0"></span>
    </p>
    <form action="">
      <input type="file" name="file" id="file" />
      <input type="button" value="停止" id="stop" />
    </form>
    <script>
      var fileForm = document.getElementById('file')
      var stopBtn = document.getElementById('stop')
      var upload = new Upload()
      var uploadApi = "http://112.74.166.214:8282/index.php/api/v1/admin/upload/fileVideo"

      fileForm.onchange = function () {
        upload.addFileAndSend(this)
      }

      stopBtn.onclick = function () {
        this.value = '停止中'
        upload.stop()
        this.value = '已停止'
      }

      function Upload() {
        var xhr = new XMLHttpRequest()
        var form_data = new FormData()
        const LENGTH = 1024 * 1024 * 2
        var start = 0
        var end = start + LENGTH
        var blob
        var blob_num = 1
        var is_stop = 0

        //对外方法，传入文件对象
        this.addFileAndSend = function (that) {
          var file = that.files[0]
          blob = cutFile(file)
          sendFile(blob, file)
          blob_num += 1
        }

        //停止文件上传
        this.stop = function () {
          xhr.abort()
          is_stop = 1
        }

        //切割文件
        function cutFile(file) {
          var file_blob = file.slice(start, end)
          start = end
          end = start + LENGTH
          return file_blob
        }

        //发送文件
        function sendFile(blob, file) {
          var form_data = new FormData()
          var total_blob_num = Math.ceil(file.size / LENGTH)
          form_data.append('file', blob)
          form_data.append('blob_num', blob_num)
          form_data.append('total_blob_num', total_blob_num)
          form_data.append('file_name', file.name)
          xhr.open(
            'POST',
            uploadApi,
            false
          )

          xhr.onreadystatechange = function () {
            if (xhr.readyState == 4 && xhr.status == 200) {
              console.log(xhr.responseText)
            }

            var progress
            var progressObj = document.getElementById('finish')
            if (total_blob_num == 1) {
              progress = '100%'
            } else {
              progress = Math.min(100, (blob_num / total_blob_num) * 100) + '%'
            }
            progressObj.style.width = progress
            var t = setTimeout(function () {
              if (start < file.size && is_stop === 0) {
                blob = cutFile(file)
                sendFile(blob, file)
                blob_num += 1
              } else {
                setTimeout(t)
              }
            }, 1000)
          }
          xhr.send(form_data)
        }
      }
    </script>
  </body>
</html>
```

## vue3

```vue
<template>
  <div class="view_main">
    <div class="articleInfo">
      <el-form :model="fromData">
        <el-form-item label="上传视频:">
          <form @submit.prevent>
            <input
              type="file"
              name="file"
              id="file"
              ref="fileInput"
              @change="handleFileChange"
            />
          </form>
          <div class="progressDiv" v-show="isPercentage">
            <el-progress
              :text-inside="true"
              :stroke-width="20"
              :percentage="percentage"
            >
              <span>{{ progressText }}</span>
            </el-progress>
          </div>
          <div v-show="isEdit">
            <vue3VideoPlay v-bind="options" poster="" />
          </div>
        </el-form-item>
        <el-form-item>
          <div class="btnList">
            <el-button @click="submitAdd()">提交</el-button>
            <el-button @click="reset()">清空</el-button>
          </div>
        </el-form-item>
      </el-form>
    </div>
  </div>
</template>

<script lang="ts" setup>
import { isEmpty, deepCopy } from '@/utils/fun'
import { ElMessage } from 'element-plus'
import { reactive, ref, onMounted, toRaw } from 'vue'
import { GlobalStore } from '@/store/index'
import { yyyxAddApi } from '@/api/modules/yyyx'
import { onBeforeRouteLeave } from 'vue-router'
import { upload_url_video, api_url } from '@/config/upload'
import axios from 'axios'

const MainStore = GlobalStore()
const videoUrl = ref('')
const videoData = ref('')
const fromData = ref({
  video_id: '',
})

const fileInput = ref(null)
const isPercentage = ref(false)
const progressText = ref('0/0')
const percentage = ref(0)
const stopDisabled = ref(false)

const handleFileChange = () => {
  stopDisabled.value = false
  const file = fileInput.value.files[0]
  uploadFile(file, updateProgress('0/0', 0))
}

const updateProgress = (progressTexta: string, percentage1: number) => {
  progressText.value = progressTexta
  percentage.value = percentage1
}

const LENGTH = 1024 * 1024 * 2
const uploadFile = (file, onProgress) => {
  let start = 0
  let end = start + LENGTH
  let blobNum = 1
  const sendFile = (blob, file) => {
    const totalBlobNum = Math.ceil(file.size / LENGTH)
    const formData = new FormData()
    formData.append('file', blob)
    formData.append('blob_num', blobNum)
    formData.append('total_blob_num', totalBlobNum)
    formData.append('file_name', file.name)
    isPercentage.value = true

    axios
      .post(upload_url_video, formData)
      .then((res) => {
        if (blobNum < totalBlobNum) {
          start = end
          end = start + LENGTH
          blobNum += 1
          const nextBlob = cutFile(file)
          sendFile(nextBlob, file)
        }
        updateProgress(
          blobNum + '/' + totalBlobNum,
          (blobNum / totalBlobNum) * 100
        )
        if (blobNum == totalBlobNum) {
          if (res.data.status == 20000) {
            ElMessage.success('上传成功')
            videoUrl.value = api_url + res.data.data.url
            videoData.value = res.data.data
            isEdit.value = true
          }
        }
      })
      .catch((error) => {
        ElMessage.error('上传失败')
        console.log(error)
      })
  }

  const cutFile = (file) => {
    const fileBlob = file.slice(start, end)
    return fileBlob
  }
  const resumeUpload = (lastUploadedChunkIndex) => {
    start = LENGTH * lastUploadedChunkIndex
    end = start + LENGTH
    blobNum = lastUploadedChunkIndex + 1
    const blob = cutFile(file)
    sendFile(blob, file)
  }
  const lastUploadedChunkIndex = localStorage.getItem(file.name)
  if (lastUploadedChunkIndex) {
    resumeUpload(parseInt(lastUploadedChunkIndex))
  } else {
    const blob = cutFile(file)
    sendFile(blob, file)
  }
}

const submitAdd = () => {
  fromData.value.video_id = videoData.value.video_id
  yyyxAddApi(fromData.value).then((res) => {
    if (res.status == 20000) {
      reset()
    }
  })
}

const isEdit = ref(false)
const options = reactive({
  width: '500px', //播放器宽度
  height: '300px', //播放器高度
  color: '#409eff', //主题色
  title: '', //视频名称
  src: videoUrl, //视频源
  muted: false, //静音
  webFullScreen: false,
  speedRate: ['0.75', '1.0', '1.25', '1.5', '2.0'], //播放倍速
  autoPlay: false, //自动播放
  loop: false, //循环播放
  mirror: false, //镜像画面
  ligthOff: false, //关灯模式
  volume: 0.3, //默认音量大小
  control: true, //是否显示控制
  controlBtns: [
    'audioTrack',
    'quality',
    'speedRate',
    'volume',
    'setting',
    'pip',
    'pageFullScreen',
    'fullScreen',
  ], //显示所有按钮,
})
onBeforeRouteLeave(() => {
  reset()
})

const reset = () => {
  updateProgress('0/0', 0)
  MainStore.seteditYyyx(null)
  isEdit.value = true
  isPercentage.value = true
  videoUrl.value = ''
  videoData.value = ''
  fromData.value = {
    id: '',
    title: '',
    status: true,
    video_id: '',
    description: '',
    group_id: '',
  }
}

onMounted(() => {
  if (isEmpty(MainStore.editYyyx)) {
    fromData.value = deepCopy(MainStore.editYyyx)
    isEdit.value = true

    videoUrl.value = api_url + fromData.value.video_one.url
  }
})
</script>
```



# 后端



```php
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Storage;
use Modules\Admin\Services\BaseApiService;
use Modules\Admin\Models\AuthVideo as AuthVideoModel;

class VideoService extends BaseApiService{
    /**
     * @Desc: 切片上传
     *
     * @param Request $request
     * @return mixed
     */
    public function sliceUpload(Request $request)
    {
        if ($request->isMethod('POST')) {
            $file = $request->file('file');
            $blob_num = $request->get('blob_num');
            $total_blob_num = $request->get('total_blob_num');
            $extension = substr(strrchr($request->get('file_name'), '.'), 1);
            $file_name = $request->get('file_name');

            $realPath = $file->getRealPath(); //临时文件的绝对路径

            // 存储地址
            $path = date('Ymd');
            $filename = $path .'/'. $file_name . '_' . $blob_num;

            //上传
            $upload = Storage::disk('video')->put($filename, file_get_contents($realPath));

            //判断是否是最后一块，如果是则进行文件合成并且删除文件块
            if($blob_num == $total_blob_num){
                for($i=1; $i<= $total_blob_num; $i++){
                    $blob = Storage::disk('video')->get($path.'/'. $file_name.'_'.$i);
                    file_put_contents(public_path('upload/videos').'/'.$path.'/'.$file_name,$blob,FILE_APPEND);
                }
                //合并完删除文件块
                for($i=1; $i<= $total_blob_num; $i++){
                    Storage::disk('video')->delete($path.'/'. $file_name.'_'.$i);
                }

                // 修改文件名
                $video_name = uniqid('prefix', true) . '.' . $extension; // 拼接文件名和扩展名
                Storage::disk('video')->move($path.'/'.$file_name, $path.'/'.$video_name); // 移动文件到指定位置

                $url = '/upload/videos/'.$path.'/'.$video_name;
                $video_id = AuthVideoModel::insertGetId([
                    'url'=>$url,
                    'status'=>1,
                    'created_at'=> date('Y-m-d H:i:s')
                ]);
                if ($upload){
                    return $this->apiSuccess('上传成功！',
                        [
                            'video_id'=>$video_id,
                            'url'=> $url,
                            '$extension'=>$extension
                        ]);
                }else{
                    $this->apiError('上传失败！');
                }
            }
        }
    }
}
```

关于`Storage::disk('video')`

![image-20230521180212152](https://cdn.jsdelivr.net/gh/K8963/Imageshack@main/blog/202305211802180.png)