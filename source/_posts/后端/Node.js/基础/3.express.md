---
title: express基本使用
date: 2021-09-18 21:52:39
comments: false
author: 8963
tags:
  - express
  - Node.js
categories:
  - 后端

---



# Express 简介

Express 是基于 node.js 平台，快速、开放、极简的 Web 开发框架。



# Express 创建web服务器

安装express

```
npm i express@4.17.1
```

创建web服务器

```javascript
const express = require("express");

const app = express();

app.listen(80, (req, res) => {
  console.log("127.0.0.1:8080");
});

```

## GET POST请求

```javascript
app.get("/http", function (req, res) {
  res.send({ msg: "get请求成功" });
  console.log("发起get请求");
});

app.post("/http", function (req, res) {
  res.send({ msg: "post请求成功" });
  console.log("发起post请求");
});
```

req：请求对象（请求相关的属性与方法）

res：响应对象（响应相关的属性与方法）



## 获取请求参数

get：[http://127.0.0.1/http?username=postman&password=123456]

```javascript
app.get("/http", function (req, res) {
  res.send({ msg: "get请求成功" });
  console.log(req.query);
  // { username: 'postman', password: '123456' }
});
```

获取post请求的参数：

安装 body-parser 模块

```
npm install --save body-parser
```

获取参数

```javascript
const bodyParser = require("body-parser");

// parse application/x-www-form-urlencoded
app.use(bodyParser.urlencoded({ extended: false }));
//parse application/json
app.use(bodyParser.json());

app.post("/http", function (req, res) {
  res.send({ msg: "post请求成功" });
  console.log(req.body);
});
```



## 获取url中的动态参数

通过req.params对象，可以访问到URL中，通过:匹配到的动态参数:

get：[http://127.0.0.1:80/user/2]

```javascript
app.get("/user/:id", function (req, res) {
  res.send({ msg: "请求成功" });
  console.log(req.params);
  // { id: '2' }
});
```



# 托管静态资源

通过 `express.static() `我们可以非常方便地创建一个静态资源服务器

例如，通过如下代码就可以将static目录下的图片、CSS文件、JavaScript文件对外开放访问了:

```javascript
const express = require("express");
const app = express();

app.use(express.static("./static"));

app.listen(81, function (req, res) {
  console.log("http://127.0.0.1:81");
});

```

![](https://cdn.jsdelivr.net/gh/K8963/Imageshack@main/blog/202209070836738.png)

## 托管多个静态资源目录

```javascript
app.use(express.static("./static"));
app.use(express.static("./public"));
```

根据目录的添加顺序查找查找所需要的文件



## 挂在路径前缀

在托管的静态资源访问路径之前，挂载路径前缀

```javascript
app.use('/static',express.static("./static"));
```



# 路由

在Express 中，路由指的是客户端的请求与服务器处理函数之间的映射关系。

Express 中的路由分3部分组成，分别是请求的类型、请求的URL地址、处理函数，格式如下:

```
app.METHOD(PATH,HANDLER)
```

## 路由的匹配过程 

每当一个请求到达服务器之后，需要先经过路由的匹配，只有匹配成功之后，才会调用对应的处理函数。

在匹配时，会按照路由的顺序进行匹配，如果请求类型和请求的URL同时匹配成功，则 Express 会将这次请求，转交给对应的function函数进行处理。

- 按照定义的先后顺序进行匹配
- 请求类型和请求的URL同时匹配成功,才会调用对应的处理函数



## 路由模块化

将路由抽离为单独的模块

1. 创建路由模块对应的.js 文件
2. 调用express.Router)函数创建路由对象
3. 向路由对象上挂载具体的路由
4. 使用module.exports向外共享路由对象
5. 使用app.use(函数注册路由模块

```javascript
// router.js
const express = require("express");
// 创建路由对象
const router = express.Router();
// 挂在路由
router.get("/user/list", function (req, res) {
  res.send("get /user/list");
});
router.post("/user/add", function (req, res) {
  res.send("post /user/add");
});
// 向外导出路由对象
module.exports = {
  router,
};

```

注册路由

```javascript
// index.js 
const express = require("express");
const app = express();

// 导入路由模块
const router = require("./router/router");
// 注册路由模块
app.use(router);

app.listen(80, function (req, res) {
  console.log("http://127.0.0.1:80");
});
```

> `app.use()` 函数得作用，注册全局中间件

## 为路由模块添加前缀

```javascript
// 导入路由模块
const UserRouter = require("./router/router");
// 注册路由模块
app.use('user',router);
```





# 中间件

中间件（Middleware），特指业务流程的中间处理环节



# Express 中间件的调用流程

当一个请求到达 Express 的服务器之后，可以连续调用多个中间件，从而对这次请求进行预处理。

![](https://cdn.jsdelivr.net/gh/K8963/Imageshack@main/blog/202209070836604.png)

## Express 中间件的格式

Express 的中间件本质就是一个 function处理函数，Express 中间件格式：

```javascript
const express = require('express');
const app = express();
app.get('/',function(req,res,next){
	next();
})
app.listen(3000);
```

其中

```javascript
function(req,res,next){
	next();
}
```

就是中间件函数，中间件函数的形参的列表中，必须包含 next参数 ，而路由处理函数只需要包含 req和res

## next 函数作用

next 函数是实现多个中间件连续调用的关键，它表示把流转关系转交给下一个中间件或者路由。

在一个中间件中调用`next（）`表示此中间件已经处理完毕，需要将处理结果转交给下一个中间件或者路由。

## 定义中间件函数

```javascript
const mv = function (req, res, next) {
  console.log('这是一个中间件');
  // 把流转关系转交
  next();
}
```



## 全局生效的中间件

客户端发起的任何请求，到达服务器之后，都会触发的中间件，叫做全局中间件。

定义全局生效的中间:

```javascript
app.use(中间函数)
```

例子：

```javascript
const express = require('express')
const app = express();
const mw = function (req, res, next) {
  console.log('这是一个中间件');
  // 把流转关系转交
  next();
}
app.use(mw);

app.get('/',(rq,res)=> {
  res.send('get - /');
})

app.get('/user', (req, res) => {
  res.send('get - /user ');
})

app.listen(80, () => {
  console.log('http://127.0.0.1:80');
})
```

这样不管客户端哪个请求路由，都会执行中间件函数`mw`

![](https://cdn.jsdelivr.net/gh/K8963/Imageshack@main/blog/202209070836355.png)



## 中间件的作用

多个中间件之间，共享同一份req和res。基于这样的特性，我们可以在上游的中间件中，统一为req或res 对象添加自定义的属性或方法，供下游的中间件或路由进行使用。

例子：

获取请求到达服务器的时间

```javascript
const express = require('express')
const app = express();
const getDate = function (req, res, next) {
  req.date = Date.now();
  // 把流转关系转交
  next();
}
app.use(getDate);
app.get('/', (req, res) => {
  console.log(req.date);
  console.log('get - /');
  res.send('get - /');
})
app.get('/user', (req, res) => {
  console.log(req.date);
  console.log('get - /user ');
  res.send('get - /user ');
})
app.listen(80, () => {
  console.log('http://127.0.0.1:80');
})

```









