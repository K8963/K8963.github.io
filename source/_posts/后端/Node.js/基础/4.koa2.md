---
title: koa2基本使用
date: 2022-03-12 21:52:39
comments: false
author: 8963
tags:
  - JavaScript
  - Node.js
categories:
  - 后端
---



# 安装 Koa2

```
npm init -y
npm i koa2 -S
```

# 入口文件

创建`app.js`并修改`package.json`文件

```json
"scripts": {
  "start":"node app.js",
  "test": "echo \"Error: no test specified\" && exit 1"
},
```

在`app.js`中

```javascript
const Koa = require('koa2')
const app = new Koa()
const port = 9000

// 调用中间件，app.use() 返回 this
app.use(async (ctx) => {
  ctx.body = 'Hello,Koa'
  // ctx.body是ctx.response.body的简写
})

app.listen(port, () => {
  console.log('http://localhost:' + port)
})
```



# 洋葱模型

![](https://cdn.jsdelivr.net/gh/K8963/Imageshack@main/blog/202209070836038.jpg)

`Koa` 和 `Express` 都会使用到中间件，Express的中间件是顺序执行，从第一个中间件执行到最后一个中间件，发出响应：

![](https://cdn.jsdelivr.net/gh/K8963/Imageshack@main/blog/202209070837804.jpg)

Koa是从第一个中间件开始执行，遇到 `next` 进入下一个中间件，一直执行到最后一个中间件，在逆序，执行上一个中间件 `next` 之后的代码，一直到第一个中间件执行结束才发出响应。

![](https://cdn.jsdelivr.net/gh/K8963/Imageshack@main/blog/202209070837992.jpg)

使用代码解释洋葱模型

```javascript
app.use(async (ctx, next) => {
  console.log(1)
  await next()
  console.log(1)
})
app.use(async (ctx, next) => {
  console.log(2)
  await next()
  console.log(2)
})
app.use(async (ctx, next) => {
  console.log(3)
})
```

![](https://cdn.jsdelivr.net/gh/K8963/Imageshack@main/blog/202209070837696.png)

通过 `next`可以先运行下个中间件，等中间件结束后，再继续运行当前 `next()` 之后的代码。



# 路由

安装

```javascript
npm i koa-router
```

引入使用

```javascript
// 引入
const Koa = require('koa2')
const Router = require('koa-router')
const app = new Koa()
const router = new Router()
// 使用路由
router.get('/', async (ctx) => {
  ctx.body = '首页'
})

router.get('/list', async (ctx) => {
  ctx.body = '列表'
})

// 注册路由
app.use(router.routes(), router.allowedMethods())
```

关于 `allowedMethods`



## 路由拆分

将路由拆分

app.js

```javascript
// 引入路由
const router = require('./router/index.js')
// 注册路由
app.use(router.routes(), router.allowedMethods())
```

index.js

```javascript
const Router = require('koa-router')
const router = new Router()

const home = require('./home')
const list = require('./list')

router.use('/home', home.routes(), home.allowedMethods())
router.use('/list', list.routes(), list.allowedMethods())

module.exports = router
```

home.js

```javascript
const Router = require('koa-router')
const home = new Router()

home.get('/', async (ctx) => {
  ctx.body = '首页'
})

module.exports = home
```

list.js

```javascript
const Router = require('koa-router')
const list = new Router()

list.get('/', async (ctx) => {
  ctx.body = '列表页'
})

module.exports = list
```

## 路由重定向

从 `localhost:9000` 重定向到 `localhost:9000/home`

```javascript
router.use('/home', home.routes(), home.allowedMethods())
router.redirect('/', '/home')
```

## 404

404.js

```javascript
const Router = require('koa-router')
const errorPage = new Router()

errorPage.get('/', async (ctx) => {
  ctx.body = '404'
})

module.exports = errorPage
```

router/index.js

```javascript
const errorPage = require('./404')
router.use('/404', errorPage.routes(), errorPage.allowedMethods())
```

app.js

```javascript
// 404
app.use(async (ctx, next) => {
  await next()
  if (parseInt(ctx.status) === 404) {
    ctx.response.redirect('/404')
  }
})
// 注册
app.use(router.routes(), router.allowedMethods())
```



# 统一异常处理

避免每次都要自己手写404或200进行返回，因此可以创建 `utils/errorHandler.js`

```javascript
// 统一异常处理
module.exports = (app) => {
  app.use(async (ctx, next) => {
    let status = 0
    let fileName = ''
    try {
      await next()
      status = ctx.status
    } catch (err) {
      console.log(err)
      status = 500
    }
    if (status >= 400) {
      switch (status) {
        case 400:
        case 404:
        case 500:
          fileName = status
          break
        default:
          fileName = 'other'
          break
      }
    }
    ctx.response.status = status
    console.log(fileName)
  })
}
```

在`app.js`中引入

```javascript
// 统一异常处理
const errorHeader = require('./utils/errorHeader')
// 注册路由
app.use(router.routes(), router.allowedMethods())
errorHeader(app)

```

# 操作mysql

安装操作库

```
npm i mysql
```

utils/db.js

```javascript
var mysql = require('mysql')

var pool = mysql.createPool({
  host: 'localhost',
  user: 'root',
  password: 'root',
  database: 'koa_dome',
})

//对数据库进行增删改查操作的基础
function query(sql, callback) {
  pool.getConnection(function (err, connection) {
    connection.query(sql, function (err, rows) {
      callback(err, rows)
      connection.release()
    })
  })
}

exports.query = query
```

router/list.js

```javascript
list.get('/', async (ctx) => {
  let data = await new Promise((resolve, reject) => {
    let sqlLang = `select * from users`
    db.query(sqlLang, (err, data) => {
      if (err) reject(err)
      resolve(data) // 返回拿到的数据
    })
  })
  ctx.body = data
})
```

# 后端跨域

```javascript
// 安装koa2-cors
npm i koa2-cors

// 这里cors中间件一定要写在路由之前
app.use(cors());
app.use(router.routes(), router.allowedMethods())
```

# 读取静态资源文件

创建图片资源`assets\images\diudiu.png`

```javascript
// 安装koa-static
cnpm install koa-static

// 引入
const path = require('path')
const static = require('koa-static')

// 获取静态资源文件夹
app.use(static(path.join(__dirname+'/assets')));
...
app.use(router.routes(), router.allowedMethods())
```

访问http://localhost:8181/images/diudiu.png

> 路径上不需要写assets，因为我们已经指定了访问资源时， http://localhost:8181 自动指向 assets 文件夹。
>
> 由此，数据库中图片的地址只需要填写 `/images/banner1.png` 即可。

![](https://cdn.jsdelivr.net/gh/K8963/Imageshack@main/blog/202209070837026.png)

# POST 请求

前端发送 账号+密码 到后端，如果账号不存在于数据库，则注册账号

如果账号存在于数据库中，则验证密码。

验证密码通过或注册账号成功，都返回token给前端。

## 建表

设定字段

```sql
create table users (
	id INT NOT NULL PRIMARY KEY AUTO_INCREMENT,
	account VARCHAR(20) NOT NULL COMMENT '账号',
	pwd VARCHAR(20) NOT NULL COMMENT '密码',
  token LONGTEXT NOT NULL COMMENT '令牌'
);
```



## from 表单

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    <label for="account">账号</label>
    <input type="text" value="" name="account" class="account" placeholder="请输入账号" />
    <br><br>
    <label for="pwd">密码</label>
    <input type="password" value="" name="pwd" class="pwd" placeholder="请输入密码" />
    <br><br>
    <button class="btn">登录/注册</button>
</body>
</html>
<script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script>
    $('.btn').click(()=>{
        $.ajax({
            url: "/login/register",
            method: "POST",
            data: {
                account: $('.account').val(),
                pwd: $('.pwd').val()
            },
            success(res){
                console.log(res)
            },
            error(err){
                console.log(err)
            }
        })
    })
</script>

```

## 中间件

```
npm i koa-bodyparser jsonwebtoken
```

### JWT

在用户登录的路由中使用 jwt.sign 来生成token，参数

- 存入 token 的信息
- token 的钥匙，与config/password.js 配置的钥匙相同
- 保存时间，3600一小时

```javascript
const jwt = require('jsonwebtoken')

const token = jwt.sign({ myaccount: myaccount, mypwd: mypwd }, 'secret', { expiresIn: 3600 })
let obj = {
  token,
  msg: '登录成功'
}
resolve(obj)
```

## 登录注册

```javascript
const Router = require('koa-router')
const login = new Router()
const bodyParser = require('koa-bodyparser')

const db = require('../utils/db')
const jwt = require('jsonwebtoken')

login.use(bodyParser())

login.post('/register', async (ctx) => {
  // console.log(ctx.request.body)
  let userAccount = ctx.request.body.account
  let userPwd = ctx.request.body.pwd
  // 账号是否存在
  let sqlLang = `SELECT * FROM users WHERE account=${userAccount}`
  let isExist = await new Promise((resolve, reject) => {
    return db.query(sqlLang, (err, data) => {
      if (err) throw err
      data.length > 0 ? resolve(data) : resolve(false)
    })
  })

  if (isExist) {
    // 验证密码
    if (isExist[0].pwd == userPwd) {
      ctx.body = {
        token: isExist[0].token,
        msg: '登录成功',
        account: userAccount,
      }
    } else {
      ctx.body = {
        msg: '密码错误',
        account: userAccount,
      }
    }
  } else {
    // 创建新用户
    let res = await new Promise((resolve, reject) => {
      // 生成 token
      const token = jwt.sign(
        { userAccount: userAccount, userPwd: userPwd },
        'secret',
        { expiresIn: 3600 }
      )
      let sqlLang = `INSERT INTO users (account,pwd,token) values ('${userAccount}','${userPwd}','${token}')`
      return db.query(sqlLang, (err, data) => {
        if (err) throw err
        let obj = {
          token,
          msg: '注册成功',
          account: userAccount,
        }
        resolve(obj)
      })
    })
    if (res) ctx.body = res
  }
})

module.exports = login
```

至此登录注册完成

























