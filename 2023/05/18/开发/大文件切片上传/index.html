<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="theme-color" content="#0078E7"><meta name="author" content="8963"><meta name="copyright" content="8963"><meta name="generator" content="Hexo 6.2.0"><meta name="theme" content="hexo-theme-yun"><title>大文件切片上传 | 8963核电站</title><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@900&amp;display=swap" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/star-markdown-css@0.3.3/dist/yun/yun-markdown.min.css"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/prism-theme-vars/base.css"><script src="https://fastly.jsdelivr.net/npm/scrollreveal/dist/scrollreveal.min.js" defer></script><script>function initScrollReveal() {
  [".post-card",".markdown-body img"].forEach((target)=> {
    ScrollReveal().reveal(target);
  })
}
document.addEventListener("DOMContentLoaded", initScrollReveal);
document.addEventListener("pjax:success", initScrollReveal);
</script><link rel="icon" type="image/svg+xml" href="/yun.svg"><link rel="mask-icon" href="/yun.svg" color="#0078E7"><link rel="preload" href="/css/hexo-theme-yun.css" as="style"><link rel="prefetch" href="/js/sidebar.js" as="script"><link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin><link rel="preconnect" href="https://fastly.jsdelivr.net/npm/" crossorigin><script id="yun-config">
    window.Yun = {}
    window.CONFIG = {"hostname":"example.com","root":"/","title":"8963核电站","version":"1.10.6","mode":"auto","copycode":true,"page":{"isPost":true},"i18n":{"placeholder":"搜索...","empty":"找不到您查询的内容: ${query}","hits":"找到 ${hits} 条结果","hits_time":"找到 ${hits} 条结果（用时 ${time} 毫秒）"},"anonymous_image":"https://cdn.yunyoujun.cn/img/avatar/none.jpg","say":{"api":"/data/sentences.json"},"local_search":{"path":"/search.xml"},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"fireworks":{"colors":["102, 167, 221","62, 131, 225","33, 78, 194"]},"vendors":{"host":"https://fastly.jsdelivr.net/npm/","darken":"https://fastly.jsdelivr.net/npm/darken@1.5.0"}};
  </script><link rel="stylesheet" href="/css/hexo-theme-yun.css"><script src="/js/hexo-theme-yun.js" type="module"></script><meta name="description" content="大文件切片上传">
<meta property="og:type" content="article">
<meta property="og:title" content="大文件切片上传">
<meta property="og:url" content="http://example.com/2023/05/18/%E5%BC%80%E5%8F%91/%E5%A4%A7%E6%96%87%E4%BB%B6%E5%88%87%E7%89%87%E4%B8%8A%E4%BC%A0/index.html">
<meta property="og:site_name" content="8963核电站">
<meta property="og:description" content="大文件切片上传">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/K8963/Imageshack@main/blog/202305211802180.png">
<meta property="article:published_time" content="2023-05-18T15:10:00.000Z">
<meta property="article:modified_time" content="2023-05-23T04:34:49.308Z">
<meta property="article:author" content="8963">
<meta property="article:tag" content="Laravel">
<meta property="article:tag" content="Vue">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/K8963/Imageshack@main/blog/202305211802180.png"><script>(function() {
  const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches
  const setting = localStorage.getItem('darken-mode') || 'auto'
  if (setting === 'dark' || (prefersDark && setting !== 'light'))
    document.documentElement.classList.toggle('dark', true)
})()</script></head><body><script src="https://code.iconify.design/2/2.1.1/iconify.min.js"></script><script>// Define global variable
IconifyProviders = {
  // Empty prefix: overwrite default API provider configuration
  '': {
    // Use custom API first, use Iconify public API as backup
    resources: [
        'https://api.iconify.design',
    ],
    // Wait for 1 second before switching API hosts
    rotate: 1000,
  },
};</script><script defer src="https://fastly.jsdelivr.net/npm/animejs@latest"></script><script defer src="/js/ui/fireworks.js" type="module"></script><canvas class="fireworks"></canvas><div class="container"><a class="sidebar-toggle hty-icon-button" id="menu-btn"><div class="hamburger hamburger--spin" type="button"><span class="hamburger-box"><span class="hamburger-inner"></span></span></div></a><div class="sidebar-toggle sidebar-overlay"></div><aside class="sidebar"><script src="/js/sidebar.js" type="module"></script><ul class="sidebar-nav"><li class="sidebar-nav-item sidebar-nav-toc hty-icon-button sidebar-nav-active" data-target="post-toc-wrap" title="文章目录"><span class="icon iconify" data-icon="ri:list-ordered"></span></li><li class="sidebar-nav-item sidebar-nav-overview hty-icon-button" data-target="site-overview-wrap" title="站点概览"><span class="icon iconify" data-icon="ri:passport-line"></span></li></ul><div class="sidebar-panel" id="site-overview-wrap"><div class="site-info fix-top"><a class="site-author-avatar" href="/about/" title="8963"><img width="96" loading="lazy" src="/images/avatar.jpg" alt="8963"><span class="site-author-status" title="摆烂到底">😡</span></a><div class="site-author-name"><a href="/about/">8963</a></div><a class="site-name" href="/about/site.html">8963核电站</a><sub class="site-subtitle"></sub><div class="site-description"></div></div><nav class="site-state"><a class="site-state-item hty-icon-button icon-home" href="/" title="首页"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:home-line"></span></span></a><div class="site-state-item"><a href="/archives/" title="归档"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:archive-line"></span></span><span class="site-state-item-count">58</span></a></div><div class="site-state-item"><a href="/categories/" title="分类"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:folder-2-line"></span></span><span class="site-state-item-count">8</span></a></div><div class="site-state-item"><a href="/tags/" title="标签"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:price-tag-line"></span></span><span class="site-state-item-count">38</span></a></div><a class="site-state-item hty-icon-button" href="/about/" title="我"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:aliens-line"></span></span></a></nav><hr style="margin-bottom:0.5rem"><div class="links-of-author"><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://github.com/K8963" title="GitHub" target="_blank" style="color:#181717"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-github-line"></use></svg></a></div><br><a class="links-item hty-icon-button" id="toggle-mode-btn" href="javascript:;" title="Mode" style="color: #f1cb64"><span class="icon iconify" data-icon="ri:contrast-2-line"></span></a></div><div class="sidebar-panel sidebar-panel-active" id="post-toc-wrap"><div class="post-toc"><div class="post-toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%8D%E7%AB%AF"><span class="toc-number">1.</span> <span class="toc-text">前端</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#html"><span class="toc-number">1.1.</span> <span class="toc-text">html</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#vue3"><span class="toc-number">1.2.</span> <span class="toc-text">vue3</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%90%8E%E7%AB%AF"><span class="toc-number">2.</span> <span class="toc-text">后端</span></a></li></ol></div></div></div></aside><main class="sidebar-translate" id="content"><div id="post"><article class="hty-card post-block" itemscope itemtype="https://schema.org/Article" style="--smc-primary:#0078E7;"><link itemprop="mainEntityOfPage" href="http://example.com/2023/05/18/%E5%BC%80%E5%8F%91/%E5%A4%A7%E6%96%87%E4%BB%B6%E5%88%87%E7%89%87%E4%B8%8A%E4%BC%A0/"><span hidden itemprop="author" itemscope itemtype="https://schema.org/Person"><meta itemprop="name" content="8963"><meta itemprop="description"></span><span hidden itemprop="publisher" itemscope itemtype="https://schema.org/Organization"><meta itemprop="name" content="8963核电站"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">大文件切片上传</h1><div class="post-meta"><div class="post-time"><span class="post-meta-item-icon"><span class="icon iconify" data-icon="ri:calendar-line"></span></span> <span class="post-meta-icon-text">发表于</span> <time title="创建时间：2023-05-18 23:10:00" itemprop="dateCreated datePublished" datetime="2023-05-18T23:10:00+08:00">2023-05-18</time></div><div class="post-classify"><span class="post-category"> <span class="post-meta-item-icon" style="margin-right:3px;"><span class="icon iconify" data-icon="ri:folder-line"></span></span><span itemprop="about" itemscope itemtype="https://schema.org/Thing"><a class="category-item" href="/categories/%E5%BC%80%E5%8F%91/" style="--text-color:var(--hty-text-color)" itemprop="url" rel="index"><span itemprop="text">开发</span></a></span></span><span class="post-tag"><span class="post-meta-divider">-</span><a class="tag-item" href="/tags/Laravel/" style="--text-color:#F4645F"><span class="post-meta-item-icon"><span class="icon iconify" data-icon="ri:price-tag-3-line"></span></span><span class="tag-name">Laravel</span></a><a class="tag-item" href="/tags/Vue/" style="--text-color:#4fc08d"><span class="post-meta-item-icon"><span class="icon iconify" data-icon="ri:price-tag-3-line"></span></span><span class="tag-name">Vue</span></a></span></div><div class="post-author"><span class="author-name">8963</span></div></div></header><section class="post-body" itemprop="articleBody"><div class="post-content markdown-body"><p>大文件切片上传</p>
<span id="more"></span>

<h1 id="前端"><a href="#前端" class="headerlink" title="前端"></a>前端</h1><h2 id="html"><a href="#html" class="headerlink" title="html"></a>html</h2><pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span>
      <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>viewport<span class="token punctuation">"</span></span>
      <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0<span class="token punctuation">"</span></span>
    <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>X-UA-Compatible<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ie=edge<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>Document<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">></span></span><span class="token style"><span class="token language-css">
      <span class="token selector">#progress</span> <span class="token punctuation">&#123;</span>
        <span class="token property">width</span><span class="token punctuation">:</span> 300px<span class="token punctuation">;</span>
        <span class="token property">height</span><span class="token punctuation">:</span> 20px<span class="token punctuation">;</span>
        <span class="token property">background-color</span><span class="token punctuation">:</span> #f7f7f7<span class="token punctuation">;</span>
        <span class="token property">box-shadow</span><span class="token punctuation">:</span> inset 0 1px 2px <span class="token function">rgba</span><span class="token punctuation">(</span>0<span class="token punctuation">,</span> 0<span class="token punctuation">,</span> 0<span class="token punctuation">,</span> 0.1<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token property">border-radius</span><span class="token punctuation">:</span> 4px<span class="token punctuation">;</span>
        <span class="token property">background-image</span><span class="token punctuation">:</span> <span class="token function">linear-gradient</span><span class="token punctuation">(</span>to bottom<span class="token punctuation">,</span> #f5f5f5<span class="token punctuation">,</span> #f9f9f9<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>

      <span class="token selector">#finish</span> <span class="token punctuation">&#123;</span>
        <span class="token property">background-color</span><span class="token punctuation">:</span> #149bdf<span class="token punctuation">;</span>
        <span class="token property">background-image</span><span class="token punctuation">:</span> <span class="token function">linear-gradient</span><span class="token punctuation">(</span>
          45deg<span class="token punctuation">,</span>
          <span class="token function">rgba</span><span class="token punctuation">(</span>255<span class="token punctuation">,</span> 255<span class="token punctuation">,</span> 255<span class="token punctuation">,</span> 0.15<span class="token punctuation">)</span> 25%<span class="token punctuation">,</span>
          transparent 25%<span class="token punctuation">,</span>
          transparent 50%<span class="token punctuation">,</span>
          <span class="token function">rgba</span><span class="token punctuation">(</span>255<span class="token punctuation">,</span> 255<span class="token punctuation">,</span> 255<span class="token punctuation">,</span> 0.15<span class="token punctuation">)</span> 50%<span class="token punctuation">,</span>
          <span class="token function">rgba</span><span class="token punctuation">(</span>255<span class="token punctuation">,</span> 255<span class="token punctuation">,</span> 255<span class="token punctuation">,</span> 0.15<span class="token punctuation">)</span> 75%<span class="token punctuation">,</span>
          transparent 75%<span class="token punctuation">,</span>
          transparent
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token property">background-size</span><span class="token punctuation">:</span> 40px 40px<span class="token punctuation">;</span>
        <span class="token property">display</span><span class="token punctuation">:</span> inline-block<span class="token punctuation">;</span>
        <span class="token property">height</span><span class="token punctuation">:</span> 20px<span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
      <span class="token selector">form</span> <span class="token punctuation">&#123;</span>
        <span class="token property">margin-top</span><span class="token punctuation">:</span> 50px<span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>progress<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>finish<span class="token punctuation">"</span></span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">width</span><span class="token punctuation">:</span> 0%</span><span class="token punctuation">"</span></span></span> <span class="token attr-name">progress</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>file<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>file<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>file<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>button<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>停止<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stop<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">
      <span class="token keyword">var</span> fileForm <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'file'</span><span class="token punctuation">)</span>
      <span class="token keyword">var</span> stopBtn <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'stop'</span><span class="token punctuation">)</span>
      <span class="token keyword">var</span> upload <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Upload</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token keyword">var</span> uploadApi <span class="token operator">=</span> <span class="token string">"http://112.74.166.214:8282/index.php/api/v1/admin/upload/fileVideo"</span>

      fileForm<span class="token punctuation">.</span><span class="token function-variable function">onchange</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        upload<span class="token punctuation">.</span><span class="token function">addFileAndSend</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
      <span class="token punctuation">&#125;</span>

      stopBtn<span class="token punctuation">.</span><span class="token function-variable function">onclick</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token string">'停止中'</span>
        upload<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token string">'已停止'</span>
      <span class="token punctuation">&#125;</span>

      <span class="token keyword">function</span> <span class="token function">Upload</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">var</span> xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">var</span> form_data <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FormData</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">const</span> <span class="token constant">LENGTH</span> <span class="token operator">=</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">2</span>
        <span class="token keyword">var</span> start <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token keyword">var</span> end <span class="token operator">=</span> start <span class="token operator">+</span> <span class="token constant">LENGTH</span>
        <span class="token keyword">var</span> blob
        <span class="token keyword">var</span> blob_num <span class="token operator">=</span> <span class="token number">1</span>
        <span class="token keyword">var</span> is_stop <span class="token operator">=</span> <span class="token number">0</span>

        <span class="token comment">//对外方法，传入文件对象</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function-variable function">addFileAndSend</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">that</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">var</span> file <span class="token operator">=</span> that<span class="token punctuation">.</span>files<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
          blob <span class="token operator">=</span> <span class="token function">cutFile</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span>
          <span class="token function">sendFile</span><span class="token punctuation">(</span>blob<span class="token punctuation">,</span> file<span class="token punctuation">)</span>
          blob_num <span class="token operator">+=</span> <span class="token number">1</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">//停止文件上传</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function-variable function">stop</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          xhr<span class="token punctuation">.</span><span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          is_stop <span class="token operator">=</span> <span class="token number">1</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">//切割文件</span>
        <span class="token keyword">function</span> <span class="token function">cutFile</span><span class="token punctuation">(</span><span class="token parameter">file</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">var</span> file_blob <span class="token operator">=</span> file<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> end<span class="token punctuation">)</span>
          start <span class="token operator">=</span> end
          end <span class="token operator">=</span> start <span class="token operator">+</span> <span class="token constant">LENGTH</span>
          <span class="token keyword">return</span> file_blob
        <span class="token punctuation">&#125;</span>

        <span class="token comment">//发送文件</span>
        <span class="token keyword">function</span> <span class="token function">sendFile</span><span class="token punctuation">(</span><span class="token parameter">blob<span class="token punctuation">,</span> file</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">var</span> form_data <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FormData</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token keyword">var</span> total_blob_num <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span>size <span class="token operator">/</span> <span class="token constant">LENGTH</span><span class="token punctuation">)</span>
          form_data<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'file'</span><span class="token punctuation">,</span> blob<span class="token punctuation">)</span>
          form_data<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'blob_num'</span><span class="token punctuation">,</span> blob_num<span class="token punctuation">)</span>
          form_data<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'total_blob_num'</span><span class="token punctuation">,</span> total_blob_num<span class="token punctuation">)</span>
          form_data<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'file_name'</span><span class="token punctuation">,</span> file<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
          xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span>
            <span class="token string">'POST'</span><span class="token punctuation">,</span>
            uploadApi<span class="token punctuation">,</span>
            <span class="token boolean">false</span>
          <span class="token punctuation">)</span>

          xhr<span class="token punctuation">.</span><span class="token function-variable function">onreadystatechange</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>readyState <span class="token operator">==</span> <span class="token number">4</span> <span class="token operator">&amp;&amp;</span> xhr<span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
              console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>responseText<span class="token punctuation">)</span>
            <span class="token punctuation">&#125;</span>

            <span class="token keyword">var</span> progress
            <span class="token keyword">var</span> progressObj <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'finish'</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>total_blob_num <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
              progress <span class="token operator">=</span> <span class="token string">'100%'</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
              progress <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>blob_num <span class="token operator">/</span> total_blob_num<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'%'</span>
            <span class="token punctuation">&#125;</span>
            progressObj<span class="token punctuation">.</span>style<span class="token punctuation">.</span>width <span class="token operator">=</span> progress
            <span class="token keyword">var</span> t <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span>start <span class="token operator">&lt;</span> file<span class="token punctuation">.</span>size <span class="token operator">&amp;&amp;</span> is_stop <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                blob <span class="token operator">=</span> <span class="token function">cutFile</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span>
                <span class="token function">sendFile</span><span class="token punctuation">(</span>blob<span class="token punctuation">,</span> file<span class="token punctuation">)</span>
                blob_num <span class="token operator">+=</span> <span class="token number">1</span>
              <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                <span class="token function">setTimeout</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span>
              <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>
          <span class="token punctuation">&#125;</span>
          xhr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>form_data<span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span>
    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></code></pre>

<h2 id="vue3"><a href="#vue3" class="headerlink" title="vue3"></a>vue3</h2><pre class="language-vue" data-language="vue"><code class="language-vue">&lt;template&gt;
  &lt;div class&#x3D;&quot;view_main&quot;&gt;
    &lt;div class&#x3D;&quot;articleInfo&quot;&gt;
      &lt;el-form :model&#x3D;&quot;fromData&quot;&gt;
        &lt;el-form-item label&#x3D;&quot;上传视频:&quot;&gt;
          &lt;form @submit.prevent&gt;
            &lt;input
              type&#x3D;&quot;file&quot;
              name&#x3D;&quot;file&quot;
              id&#x3D;&quot;file&quot;
              ref&#x3D;&quot;fileInput&quot;
              @change&#x3D;&quot;handleFileChange&quot;
            &#x2F;&gt;
          &lt;&#x2F;form&gt;
          &lt;div class&#x3D;&quot;progressDiv&quot; v-show&#x3D;&quot;isPercentage&quot;&gt;
            &lt;el-progress
              :text-inside&#x3D;&quot;true&quot;
              :stroke-width&#x3D;&quot;20&quot;
              :percentage&#x3D;&quot;percentage&quot;
            &gt;
              &lt;span&gt;&#123;&#123; progressText &#125;&#125;&lt;&#x2F;span&gt;
            &lt;&#x2F;el-progress&gt;
          &lt;&#x2F;div&gt;
          &lt;div v-show&#x3D;&quot;isEdit&quot;&gt;
            &lt;vue3VideoPlay v-bind&#x3D;&quot;options&quot; poster&#x3D;&quot;&quot; &#x2F;&gt;
          &lt;&#x2F;div&gt;
        &lt;&#x2F;el-form-item&gt;
        &lt;el-form-item&gt;
          &lt;div class&#x3D;&quot;btnList&quot;&gt;
            &lt;el-button @click&#x3D;&quot;submitAdd()&quot;&gt;提交&lt;&#x2F;el-button&gt;
            &lt;el-button @click&#x3D;&quot;reset()&quot;&gt;清空&lt;&#x2F;el-button&gt;
          &lt;&#x2F;div&gt;
        &lt;&#x2F;el-form-item&gt;
      &lt;&#x2F;el-form&gt;
    &lt;&#x2F;div&gt;
  &lt;&#x2F;div&gt;
&lt;&#x2F;template&gt;

&lt;script lang&#x3D;&quot;ts&quot; setup&gt;
import &#123; isEmpty, deepCopy &#125; from &#39;@&#x2F;utils&#x2F;fun&#39;
import &#123; ElMessage &#125; from &#39;element-plus&#39;
import &#123; reactive, ref, onMounted, toRaw &#125; from &#39;vue&#39;
import &#123; GlobalStore &#125; from &#39;@&#x2F;store&#x2F;index&#39;
import &#123; yyyxAddApi &#125; from &#39;@&#x2F;api&#x2F;modules&#x2F;yyyx&#39;
import &#123; onBeforeRouteLeave &#125; from &#39;vue-router&#39;
import &#123; upload_url_video, api_url &#125; from &#39;@&#x2F;config&#x2F;upload&#39;
import axios from &#39;axios&#39;

const MainStore &#x3D; GlobalStore()
const videoUrl &#x3D; ref(&#39;&#39;)
const videoData &#x3D; ref(&#39;&#39;)
const fromData &#x3D; ref(&#123;
  video_id: &#39;&#39;,
&#125;)

const fileInput &#x3D; ref(null)
const isPercentage &#x3D; ref(false)
const progressText &#x3D; ref(&#39;0&#x2F;0&#39;)
const percentage &#x3D; ref(0)
const stopDisabled &#x3D; ref(false)

const handleFileChange &#x3D; () &#x3D;&gt; &#123;
  stopDisabled.value &#x3D; false
  const file &#x3D; fileInput.value.files[0]
  uploadFile(file, updateProgress(&#39;0&#x2F;0&#39;, 0))
&#125;

const updateProgress &#x3D; (progressTexta: string, percentage1: number) &#x3D;&gt; &#123;
  progressText.value &#x3D; progressTexta
  percentage.value &#x3D; percentage1
&#125;

const LENGTH &#x3D; 1024 * 1024 * 2
const uploadFile &#x3D; (file, onProgress) &#x3D;&gt; &#123;
  let start &#x3D; 0
  let end &#x3D; start + LENGTH
  let blobNum &#x3D; 1
  const sendFile &#x3D; (blob, file) &#x3D;&gt; &#123;
    const totalBlobNum &#x3D; Math.ceil(file.size &#x2F; LENGTH)
    const formData &#x3D; new FormData()
    formData.append(&#39;file&#39;, blob)
    formData.append(&#39;blob_num&#39;, blobNum)
    formData.append(&#39;total_blob_num&#39;, totalBlobNum)
    formData.append(&#39;file_name&#39;, file.name)
    isPercentage.value &#x3D; true

    axios
      .post(upload_url_video, formData)
      .then((res) &#x3D;&gt; &#123;
        if (blobNum &lt; totalBlobNum) &#123;
          start &#x3D; end
          end &#x3D; start + LENGTH
          blobNum +&#x3D; 1
          const nextBlob &#x3D; cutFile(file)
          sendFile(nextBlob, file)
        &#125;
        updateProgress(
          blobNum + &#39;&#x2F;&#39; + totalBlobNum,
          (blobNum &#x2F; totalBlobNum) * 100
        )
        if (blobNum &#x3D;&#x3D; totalBlobNum) &#123;
          if (res.data.status &#x3D;&#x3D; 20000) &#123;
            ElMessage.success(&#39;上传成功&#39;)
            videoUrl.value &#x3D; api_url + res.data.data.url
            videoData.value &#x3D; res.data.data
            isEdit.value &#x3D; true
          &#125;
        &#125;
      &#125;)
      .catch((error) &#x3D;&gt; &#123;
        ElMessage.error(&#39;上传失败&#39;)
        console.log(error)
      &#125;)
  &#125;

  const cutFile &#x3D; (file) &#x3D;&gt; &#123;
    const fileBlob &#x3D; file.slice(start, end)
    return fileBlob
  &#125;
  const resumeUpload &#x3D; (lastUploadedChunkIndex) &#x3D;&gt; &#123;
    start &#x3D; LENGTH * lastUploadedChunkIndex
    end &#x3D; start + LENGTH
    blobNum &#x3D; lastUploadedChunkIndex + 1
    const blob &#x3D; cutFile(file)
    sendFile(blob, file)
  &#125;
  const lastUploadedChunkIndex &#x3D; localStorage.getItem(file.name)
  if (lastUploadedChunkIndex) &#123;
    resumeUpload(parseInt(lastUploadedChunkIndex))
  &#125; else &#123;
    const blob &#x3D; cutFile(file)
    sendFile(blob, file)
  &#125;
&#125;

const submitAdd &#x3D; () &#x3D;&gt; &#123;
  fromData.value.video_id &#x3D; videoData.value.video_id
  yyyxAddApi(fromData.value).then((res) &#x3D;&gt; &#123;
    if (res.status &#x3D;&#x3D; 20000) &#123;
      reset()
    &#125;
  &#125;)
&#125;

const isEdit &#x3D; ref(false)
const options &#x3D; reactive(&#123;
  width: &#39;500px&#39;, &#x2F;&#x2F;播放器宽度
  height: &#39;300px&#39;, &#x2F;&#x2F;播放器高度
  color: &#39;#409eff&#39;, &#x2F;&#x2F;主题色
  title: &#39;&#39;, &#x2F;&#x2F;视频名称
  src: videoUrl, &#x2F;&#x2F;视频源
  muted: false, &#x2F;&#x2F;静音
  webFullScreen: false,
  speedRate: [&#39;0.75&#39;, &#39;1.0&#39;, &#39;1.25&#39;, &#39;1.5&#39;, &#39;2.0&#39;], &#x2F;&#x2F;播放倍速
  autoPlay: false, &#x2F;&#x2F;自动播放
  loop: false, &#x2F;&#x2F;循环播放
  mirror: false, &#x2F;&#x2F;镜像画面
  ligthOff: false, &#x2F;&#x2F;关灯模式
  volume: 0.3, &#x2F;&#x2F;默认音量大小
  control: true, &#x2F;&#x2F;是否显示控制
  controlBtns: [
    &#39;audioTrack&#39;,
    &#39;quality&#39;,
    &#39;speedRate&#39;,
    &#39;volume&#39;,
    &#39;setting&#39;,
    &#39;pip&#39;,
    &#39;pageFullScreen&#39;,
    &#39;fullScreen&#39;,
  ], &#x2F;&#x2F;显示所有按钮,
&#125;)
onBeforeRouteLeave(() &#x3D;&gt; &#123;
  reset()
&#125;)

const reset &#x3D; () &#x3D;&gt; &#123;
  updateProgress(&#39;0&#x2F;0&#39;, 0)
  MainStore.seteditYyyx(null)
  isEdit.value &#x3D; true
  isPercentage.value &#x3D; true
  videoUrl.value &#x3D; &#39;&#39;
  videoData.value &#x3D; &#39;&#39;
  fromData.value &#x3D; &#123;
    id: &#39;&#39;,
    title: &#39;&#39;,
    status: true,
    video_id: &#39;&#39;,
    description: &#39;&#39;,
    group_id: &#39;&#39;,
  &#125;
&#125;

onMounted(() &#x3D;&gt; &#123;
  if (isEmpty(MainStore.editYyyx)) &#123;
    fromData.value &#x3D; deepCopy(MainStore.editYyyx)
    isEdit.value &#x3D; true

    videoUrl.value &#x3D; api_url + fromData.value.video_one.url
  &#125;
&#125;)
&lt;&#x2F;script&gt;</code></pre>



<h1 id="后端"><a href="#后端" class="headerlink" title="后端"></a>后端</h1><pre class="language-php" data-language="php"><code class="language-php"><span class="token keyword">use</span> <span class="token package">Illuminate<span class="token punctuation">\</span>Http<span class="token punctuation">\</span>Request</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Illuminate<span class="token punctuation">\</span>Support<span class="token punctuation">\</span>Facades<span class="token punctuation">\</span>Storage</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Modules<span class="token punctuation">\</span>Admin<span class="token punctuation">\</span>Services<span class="token punctuation">\</span>BaseApiService</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Modules<span class="token punctuation">\</span>Admin<span class="token punctuation">\</span>Models<span class="token punctuation">\</span>AuthVideo</span> <span class="token keyword">as</span> AuthVideoModel<span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">VideoService</span> <span class="token keyword">extends</span> <span class="token class-name">BaseApiService</span><span class="token punctuation">&#123;</span>
    <span class="token comment">/**
     * @Desc: 切片上传
     *
     * @param Request $request
     * @return mixed
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">sliceUpload</span><span class="token punctuation">(</span><span class="token class-name type-declaration">Request</span> <span class="token variable">$request</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$request</span><span class="token operator">-></span><span class="token function">isMethod</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'POST'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token variable">$file</span> <span class="token operator">=</span> <span class="token variable">$request</span><span class="token operator">-></span><span class="token function">file</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'file'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token variable">$blob_num</span> <span class="token operator">=</span> <span class="token variable">$request</span><span class="token operator">-></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'blob_num'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token variable">$total_blob_num</span> <span class="token operator">=</span> <span class="token variable">$request</span><span class="token operator">-></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'total_blob_num'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token variable">$extension</span> <span class="token operator">=</span> <span class="token function">substr</span><span class="token punctuation">(</span><span class="token function">strrchr</span><span class="token punctuation">(</span><span class="token variable">$request</span><span class="token operator">-></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'file_name'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token variable">$file_name</span> <span class="token operator">=</span> <span class="token variable">$request</span><span class="token operator">-></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'file_name'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token variable">$realPath</span> <span class="token operator">=</span> <span class="token variable">$file</span><span class="token operator">-></span><span class="token function">getRealPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//临时文件的绝对路径</span>

            <span class="token comment">// 存储地址</span>
            <span class="token variable">$path</span> <span class="token operator">=</span> <span class="token function">date</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Ymd'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token variable">$filename</span> <span class="token operator">=</span> <span class="token variable">$path</span> <span class="token operator">.</span><span class="token string single-quoted-string">'/'</span><span class="token operator">.</span> <span class="token variable">$file_name</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'_'</span> <span class="token operator">.</span> <span class="token variable">$blob_num</span><span class="token punctuation">;</span>

            <span class="token comment">//上传</span>
            <span class="token variable">$upload</span> <span class="token operator">=</span> <span class="token class-name static-context">Storage</span><span class="token operator">::</span><span class="token function">disk</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'video'</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">put</span><span class="token punctuation">(</span><span class="token variable">$filename</span><span class="token punctuation">,</span> <span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$realPath</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//判断是否是最后一块，如果是则进行文件合成并且删除文件块</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$blob_num</span> <span class="token operator">==</span> <span class="token variable">$total_blob_num</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token variable">$i</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token variable">$i</span><span class="token operator">&lt;=</span> <span class="token variable">$total_blob_num</span><span class="token punctuation">;</span> <span class="token variable">$i</span><span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                    <span class="token variable">$blob</span> <span class="token operator">=</span> <span class="token class-name static-context">Storage</span><span class="token operator">::</span><span class="token function">disk</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'video'</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token variable">$path</span><span class="token operator">.</span><span class="token string single-quoted-string">'/'</span><span class="token operator">.</span> <span class="token variable">$file_name</span><span class="token operator">.</span><span class="token string single-quoted-string">'_'</span><span class="token operator">.</span><span class="token variable">$i</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">file_put_contents</span><span class="token punctuation">(</span><span class="token function">public_path</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'upload/videos'</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token string single-quoted-string">'/'</span><span class="token operator">.</span><span class="token variable">$path</span><span class="token operator">.</span><span class="token string single-quoted-string">'/'</span><span class="token operator">.</span><span class="token variable">$file_name</span><span class="token punctuation">,</span><span class="token variable">$blob</span><span class="token punctuation">,</span><span class="token constant">FILE_APPEND</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                <span class="token comment">//合并完删除文件块</span>
                <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token variable">$i</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token variable">$i</span><span class="token operator">&lt;=</span> <span class="token variable">$total_blob_num</span><span class="token punctuation">;</span> <span class="token variable">$i</span><span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                    <span class="token class-name static-context">Storage</span><span class="token operator">::</span><span class="token function">disk</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'video'</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token variable">$path</span><span class="token operator">.</span><span class="token string single-quoted-string">'/'</span><span class="token operator">.</span> <span class="token variable">$file_name</span><span class="token operator">.</span><span class="token string single-quoted-string">'_'</span><span class="token operator">.</span><span class="token variable">$i</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>

                <span class="token comment">// 修改文件名</span>
                <span class="token variable">$video_name</span> <span class="token operator">=</span> <span class="token function">uniqid</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'prefix'</span><span class="token punctuation">,</span> <span class="token constant boolean">true</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'.'</span> <span class="token operator">.</span> <span class="token variable">$extension</span><span class="token punctuation">;</span> <span class="token comment">// 拼接文件名和扩展名</span>
                <span class="token class-name static-context">Storage</span><span class="token operator">::</span><span class="token function">disk</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'video'</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">move</span><span class="token punctuation">(</span><span class="token variable">$path</span><span class="token operator">.</span><span class="token string single-quoted-string">'/'</span><span class="token operator">.</span><span class="token variable">$file_name</span><span class="token punctuation">,</span> <span class="token variable">$path</span><span class="token operator">.</span><span class="token string single-quoted-string">'/'</span><span class="token operator">.</span><span class="token variable">$video_name</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 移动文件到指定位置</span>

                <span class="token variable">$url</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'/upload/videos/'</span><span class="token operator">.</span><span class="token variable">$path</span><span class="token operator">.</span><span class="token string single-quoted-string">'/'</span><span class="token operator">.</span><span class="token variable">$video_name</span><span class="token punctuation">;</span>
                <span class="token variable">$video_id</span> <span class="token operator">=</span> <span class="token class-name static-context">AuthVideoModel</span><span class="token operator">::</span><span class="token function">insertGetId</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
                    <span class="token string single-quoted-string">'url'</span><span class="token operator">=></span><span class="token variable">$url</span><span class="token punctuation">,</span>
                    <span class="token string single-quoted-string">'status'</span><span class="token operator">=></span><span class="token number">1</span><span class="token punctuation">,</span>
                    <span class="token string single-quoted-string">'created_at'</span><span class="token operator">=></span> <span class="token function">date</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Y-m-d H:i:s'</span><span class="token punctuation">)</span>
                <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$upload</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                    <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">apiSuccess</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'上传成功！'</span><span class="token punctuation">,</span>
                        <span class="token punctuation">[</span>
                            <span class="token string single-quoted-string">'video_id'</span><span class="token operator">=></span><span class="token variable">$video_id</span><span class="token punctuation">,</span>
                            <span class="token string single-quoted-string">'url'</span><span class="token operator">=></span> <span class="token variable">$url</span><span class="token punctuation">,</span>
                            <span class="token string single-quoted-string">'$extension'</span><span class="token operator">=></span><span class="token variable">$extension</span>
                        <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span>
                    <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">apiError</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'上传失败！'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>关于<code>Storage::disk(&#39;video&#39;)</code></p>
<p><img src="https://cdn.jsdelivr.net/gh/K8963/Imageshack@main/blog/202305211802180.png" alt="image-20230521180212152" loading="lazy"></p>
</div></section><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者：</strong>8963</li><li class="post-copyright-link"><strong>本文链接：</strong><a href="http://example.com/2023/05/18/%E5%BC%80%E5%8F%91/%E5%A4%A7%E6%96%87%E4%BB%B6%E5%88%87%E7%89%87%E4%B8%8A%E4%BC%A0/" title="大文件切片上传">http://example.com/2023/05/18/%E5%BC%80%E5%8F%91/%E5%A4%A7%E6%96%87%E4%BB%B6%E5%88%87%E7%89%87%E4%B8%8A%E4%BC%A0/</a></li><li class="post-copyright-license"><strong>版权声明：</strong>本博客所有文章除特别声明外，均默认采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener" title="CC BY-NC-SA 4.0 "><span class="icon iconify" data-icon="ri:creative-commons-line"></span><span class="icon iconify" data-icon="ri:creative-commons-by-line"></span><span class="icon iconify" data-icon="ri:creative-commons-nc-line"></span><span class="icon iconify" data-icon="ri:creative-commons-sa-line"></span></a> 许可协议。</li></ul></article><div class="post-nav"><div class="post-nav-item"></div><div class="post-nav-item"><a class="post-nav-next" href="/2023/05/18/%E7%8E%AF%E5%A2%83%E5%B7%A5%E5%85%B7/WSL/" rel="next" title="WSL"><span class="post-nav-text">WSL</span><span class="icon iconify" data-icon="ri:arrow-right-s-line"></span></a></div></div></div></main><footer class="sidebar-translate" id="footer"><div class="copyright"><span>&copy; 2019 – 2023 </span><span class="with-love" id="animate"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-cloud-line"></use></svg></span><span class="author"> 8963</span></div></footer></div><a class="hty-icon-button" id="back-to-top" aria-label="back-to-top" href="#"><span class="icon iconify" data-icon="ri:arrow-up-s-line"></span><svg class="progress-circle-container" viewBox="0 0 100 100"><circle class="progress-circle" id="progressCircle" cx="50" cy="50" r="48" fill="none" stroke="#0078E7" stroke-width="2" stroke-linecap="round"></circle></svg></a><a class="popup-trigger hty-icon-button icon-search" id="search" href="javascript:;" title="搜索"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:search-line"></span></span></a><script>window.addEventListener("DOMContentLoaded", () => {
  // Handle and trigger popup window
  document.querySelector(".popup-trigger").addEventListener("click", () => {
    document.querySelector(".popup").classList.add("show");
    setTimeout(() => {
      document.querySelector(".search-input").focus();
    }, 100);
  });

  // Monitor main search box
  const onPopupClose = () => {
    document.querySelector(".popup").classList.remove("show");
  };

  document.querySelector(".popup-btn-close").addEventListener("click", () => {
    onPopupClose();
  });

  window.addEventListener("keyup", event => {
    if (event.key === "Escape") {
      onPopupClose();
    }
  });
});
</script><script src="https://fastly.jsdelivr.net/npm/hexo-generator-searchdb@1.4.0/dist/search.js"></script><script src="/js/search/local-search.js" defer type="module"></script><div class="popup search-popup"><div class="search-header"><span class="popup-btn-close close-icon hty-icon-button"><span class="icon iconify" data-icon="ri:close-line"></span></span></div><div class="search-input-container"><input class="search-input" id="local-search-input" type="text" placeholder="搜索..." value=""></div><div class="search-result-container"></div></div><script src="https://fastly.jsdelivr.net/npm/medium-zoom@1.0.6/dist/medium-zoom.min.js"></script><script>const images = [...document.querySelectorAll('.markdown-body img')]
mediumZoom(images)</script><style>.medium-zoom-image {
  z-index: 99;
}</style></body></html>